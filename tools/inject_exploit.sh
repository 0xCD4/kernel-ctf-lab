#!/bin/bash
#
# inject_exploit.sh - Pack your exploit into a challenge's initramfs
#
# Usage: ./inject_exploit.sh <challenge_dir> <exploit_binary>
#
# Example:
#   gcc -static -o exploit exploit.c -lpthread
#   ./inject_exploit.sh ../challenges/ch01-stacksmasher ./exploit
#
set -e

CHDIR="${1:?Usage: $0 <challenge_dir> <exploit_binary>}"
EXPLOIT="${2:?Usage: $0 <challenge_dir> <exploit_binary>}"

# Convert to absolute paths
CHDIR="$(cd "$CHDIR" && pwd)"
EXPLOIT="$(realpath "$EXPLOIT")"
INITRAMFS="$CHDIR/initramfs.cpio.gz"

if [ ! -f "$INITRAMFS" ]; then
    echo "[!] initramfs not found: $INITRAMFS"
    exit 1
fi

if [ ! -f "$EXPLOIT" ]; then
    echo "[!] Exploit binary not found: $EXPLOIT"
    exit 1
fi

# Check static
if file "$EXPLOIT" | grep -q "dynamically linked"; then
    echo "[!] WARNING: Exploit is dynamically linked."
    echo "    The QEMU VM has no shared libraries."
    echo "    Recompile with: gcc -static -o exploit exploit.c"
    echo ""
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
fi

TMP=$(mktemp -d)
echo "[*] Unpacking initramfs..."
(cd "$TMP" && gunzip -c "$INITRAMFS" | cpio -idm 2>/dev/null)

echo "[*] Injecting $(basename "$EXPLOIT") -> /home/ctf/"
mkdir -p "$TMP/home/ctf"
cp "$EXPLOIT" "$TMP/home/ctf/$(basename "$EXPLOIT")"
chmod +x "$TMP/home/ctf/$(basename "$EXPLOIT")"

echo "[*] Repacking initramfs..."
(cd "$TMP" && find . -print0 | cpio --null -o --format=newc 2>/dev/null | gzip -9 > "$INITRAMFS")

rm -rf "$TMP"
echo "[+] Done. Exploit available at /home/ctf/$(basename "$EXPLOIT") inside VM."
echo "    Run: cd $CHDIR && ./run.sh 0"
